---
// src/pages/builders/projects/join.astro
import Layout from "../../../layouts/Layout.astro";
import { getSession } from "../../../lib/auth";

const session = await getSession(Astro.cookies);
if (!session?.wallet) {
  return Astro.redirect("/builders");
}
---

<Layout title="Unirse a Proyecto | Construyendo Juntos">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-6">
      <a href="/builders" class="text-[#9945FF] hover:text-[#8338EB]"
        >‚Üê Volver</a
      >
    </div>

    <section class="hero mb-12 text-center">
      <h1 class="text-4xl font-bold mb-4">Unirse a un Proyecto</h1>
      <p class="text-xl text-gray-600">
        Solicita unirte a un proyecto existente en la comunidad
      </p>
    </section>

    <section class="signup p-8">
      <div
        id="wallet-status"
        class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <svg
                class="h-5 w-5 text-green-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"></path>
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-green-800">Wallet conectado</p>
              <p class="text-xs font-mono text-green-600">
                {session.wallet.slice(0, 4)}...{session.wallet.slice(-4)}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div id="projects-list" class="space-y-4" data-wallet={session.wallet}>
        <p class="text-gray-600">Cargando proyectos...</p>
      </div>
    </section>
  </div>
</Layout>

<script>
  // Function to load and display projects
  const loadProjects = async () => {
    const projectsList = document.getElementById("projects-list");
    if (!projectsList) return;

    const wallet = projectsList.getAttribute("data-wallet");
    if (!wallet) {
      projectsList.innerHTML =
        '<p class="text-red-600">Error: No se encontr√≥ la direcci√≥n del wallet.</p>';
      return;
    }

    try {
      // Load all projects
      const projectsRes = await fetch("/api/projects/list");
      const projectsData = await projectsRes.json();

      // Load user's existing project links to check status
      const linksRes = await fetch(
        `/api/builders/projects?wallet=${encodeURIComponent(wallet)}`,
      );
      const linksData = await linksRes.json();

      // Create a map of project IDs to link status (joined/accepted/owner)
      const userProjects = new Map();
      if (linksData.projects) {
        linksData.projects.forEach((p: any) => {
          userProjects.set(p.id, "member");
        });
      }

      // Also check for pending requests by fetching all links for this wallet
      const pendingRes = await fetch(
        `/api/builders/pending-requests?wallet=${encodeURIComponent(wallet)}`,
      );
      let pendingProjects = new Set();
      try {
        const pendingData = await pendingRes.json();
        if (pendingData.project_ids) {
          pendingProjects = new Set(pendingData.project_ids);
        }
      } catch (e) {
        // API might not exist yet, that's okay
        console.log("Could not fetch pending requests:", e);
      }

      if (projectsData.projects && projectsData.projects.length > 0) {
        // Show ALL projects, but with status tags
        projectsList.innerHTML = "";

        projectsData.projects.forEach((project: any) => {
          // Determine user's relationship to this project
          const isOwner = project.owner_wallet === wallet;
          const isMember = userProjects.has(project.id);
          const hasPendingRequest = pendingProjects.has(project.id);
          const projectCard = document.createElement("div");
          projectCard.className =
            "border border-gray-200 rounded-lg p-6 hover:border-[#9945FF]/40 transition-colors";

          // Title with user status badge
          const titleDiv = document.createElement("div");
          titleDiv.className = "flex items-center justify-between mb-2";

          const h3 = document.createElement("h3");
          h3.className = "text-lg font-semibold";
          h3.textContent = project.name;
          titleDiv.appendChild(h3);

          // User relationship badge
          if (isOwner) {
            const ownerBadge = document.createElement("span");
            ownerBadge.className =
              "px-3 py-1 text-xs font-medium rounded-full bg-[#9945FF]/10 text-[#9945FF]";
            ownerBadge.textContent = "üëë Propietario";
            titleDiv.appendChild(ownerBadge);
          } else if (isMember) {
            const memberBadge = document.createElement("span");
            memberBadge.className =
              "px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800";
            memberBadge.textContent = "‚úì Miembro";
            titleDiv.appendChild(memberBadge);
          } else if (hasPendingRequest) {
            const pendingBadge = document.createElement("span");
            pendingBadge.className =
              "px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800";
            pendingBadge.textContent = "‚è≥ Solicitud Pendiente";
            titleDiv.appendChild(pendingBadge);
          }

          projectCard.appendChild(titleDiv);

          if (project.description) {
            const desc = document.createElement("p");
            desc.className = "text-sm text-gray-600 mb-4";
            desc.textContent = project.description;
            projectCard.appendChild(desc);
          }

          // Project links
          const linksDiv = document.createElement("div");
          linksDiv.className = "flex gap-4 mb-4 text-sm";

          if (project.website) {
            const websiteLink = document.createElement("a");
            websiteLink.href = project.website;
            websiteLink.target = "_blank";
            websiteLink.className = "text-[#9945FF] hover:underline";
            websiteLink.textContent = "üåê Sitio web";
            linksDiv.appendChild(websiteLink);
          }

          if (project.twitter) {
            const twitterLink = document.createElement("a");
            twitterLink.href = `https://twitter.com/${project.twitter.replace("@", "")}`;
            twitterLink.target = "_blank";
            twitterLink.className = "text-[#9945FF] hover:underline";
            twitterLink.textContent = "üê¶ Twitter";
            linksDiv.appendChild(twitterLink);
          }

          if (project.discord) {
            const discordLink = document.createElement("a");
            discordLink.href = project.discord;
            discordLink.target = "_blank";
            discordLink.className = "text-[#9945FF] hover:underline";
            discordLink.textContent = "üí¨ Discord";
            linksDiv.appendChild(discordLink);
          }

          if (linksDiv.children.length > 0) {
            projectCard.appendChild(linksDiv);
          }

          // Status badge - only show for non-owners (project verification status)
          if (!isOwner) {
            const statusDiv = document.createElement("div");
            statusDiv.className = "mb-4";
            const statusBadge = document.createElement("span");
            statusBadge.className = "px-2 py-1 text-xs rounded-full";
            if (project.status === "verified") {
              statusBadge.className += " bg-green-100 text-green-800";
              statusBadge.textContent = "‚úì Verificado";
            } else if (project.status === "active") {
              statusBadge.className += " bg-blue-100 text-blue-800";
              statusBadge.textContent = "Activo";
            } else {
              statusBadge.className += " bg-yellow-100 text-yellow-800";
              statusBadge.textContent = "Pendiente";
            }
            statusDiv.appendChild(statusBadge);
            projectCard.appendChild(statusDiv);
          }

          // Join button - only show if user can join
          if (!isOwner && !isMember) {
            const joinBtn = document.createElement("button");

            if (hasPendingRequest) {
              joinBtn.className =
                "px-4 py-2 bg-gray-400 text-white rounded-lg text-sm cursor-not-allowed";
              joinBtn.textContent = "Solicitud Enviada ‚úì";
              joinBtn.disabled = true;
            } else {
              joinBtn.className =
                "px-4 py-2 bg-[#9945FF] text-white rounded-lg hover:bg-[#8338EB] transition-colors text-sm";
              joinBtn.textContent = "Solicitar Unirse";
              joinBtn.disabled = false;

              joinBtn.addEventListener("click", async () => {
                joinBtn.disabled = true;
                joinBtn.textContent = "Enviando...";

                try {
                  const res = await fetch("/api/projects/join", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      project_id: project.id,
                      wallet: wallet,
                    }),
                  });

                  const result = await res.json();
                  if (res.ok) {
                    joinBtn.textContent = "Solicitud Enviada ‚úì";
                    joinBtn.disabled = true;
                    joinBtn.className =
                      "px-4 py-2 bg-gray-400 text-white rounded-lg text-sm cursor-not-allowed";

                    // Update the badge
                    const pendingBadge = document.createElement("span");
                    pendingBadge.className =
                      "px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800";
                    pendingBadge.textContent = "‚è≥ Solicitud Pendiente";
                    titleDiv.appendChild(pendingBadge);

                    // Show success message
                    const successMsg = document.createElement("p");
                    successMsg.className = "mt-2 text-sm text-green-600";
                    successMsg.textContent =
                      "Solicitud enviada. El propietario del proyecto revisar√° tu solicitud.";
                    projectCard.appendChild(successMsg);
                  } else {
                    alert("Error: " + (result.error || "Unknown error"));
                    joinBtn.disabled = false;
                    joinBtn.textContent = "Solicitar Unirse";
                  }
                } catch (err) {
                  console.error("Error joining project:", err);
                  alert(
                    "Error al enviar la solicitud. Por favor intenta de nuevo.",
                  );
                  joinBtn.disabled = false;
                  joinBtn.textContent = "Solicitar Unirse";
                }
              });
            }

            projectCard.appendChild(joinBtn);
          } else if (isOwner) {
            // Show owner message
            const ownerMsg = document.createElement("p");
            ownerMsg.className = "text-sm text-[#9945FF] font-medium";
            ownerMsg.textContent = "Eres el propietario de este proyecto";
            projectCard.appendChild(ownerMsg);
          } else if (isMember) {
            // Show member message
            const memberMsg = document.createElement("p");
            memberMsg.className = "text-sm text-green-600 font-medium";
            memberMsg.textContent = "Ya eres miembro de este proyecto";
            projectCard.appendChild(memberMsg);
          }

          projectsList.appendChild(projectCard);
        });
      } else {
        projectsList.innerHTML =
          '<p class="text-gray-600">No hay proyectos disponibles para unirse.</p>';
      }
    } catch (err) {
      console.error("Error loading projects:", err);
      const projectsList = document.getElementById("projects-list");
      if (projectsList) {
        projectsList.innerHTML =
          '<p class="text-red-600">Error al cargar proyectos. Por favor recarga la p√°gina.</p>';
      }
    }
  };

  // Run on initial load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadProjects);
  } else {
    // DOM already loaded (client-side navigation)
    loadProjects();
  }

  // Also listen for Astro navigation events
  document.addEventListener("astro:page-load", loadProjects);
</script>
