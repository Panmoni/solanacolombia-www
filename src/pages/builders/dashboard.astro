---
// src/pages/builders/dashboard.astro
import Layout from "../../layouts/Layout.astro";
import { getSession } from "../../lib/auth";

const session = await getSession(Astro.cookies);
if (!session?.wallet) {
  return Astro.redirect("/builders");
}
---

<Layout title="Dashboard | Construyendo Juntos">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6 flex justify-between items-center">
      <h1 class="text-3xl font-bold">
        Bienvenido, {session.name || session.wallet.slice(0, 8) + "..."}
      </h1>
      <a href="/builders" class="text-[#9945FF] hover:text-[#8338EB]"
        >‚Üê Volver</a
      >
    </div>

    <section class="mb-8 p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">Tu Perfil</h2>
        <a
          href="/builders/profile/edit"
          class="px-4 py-2 bg-[#9945FF] text-white rounded-lg hover:bg-[#8338EB] transition-colors text-sm"
        >
          ‚úèÔ∏è Editar Perfil
        </a>
      </div>
      <div class="space-y-2">
        <p>
          <strong>Wallet:</strong>
          <code class="bg-gray-100 px-2 py-1 rounded">{session.wallet}</code>
        </p>
        {
          session.name && (
            <p>
              <strong>Nombre:</strong> {session.name}
            </p>
          )
        }
        {
          session.role && (
            <p>
              <strong>Rol:</strong>{" "}
              <span class="px-2 py-1 bg-[#9945FF]/10 text-[#9945FF] rounded text-sm">
                {session.role}
              </span>
            </p>
          )
        }
      </div>
    </section>

    <section class="p-6">
      <h2 class="text-2xl font-semibold mb-4">Proyectos Asociados</h2>
      <div id="projects-list" data-wallet={session.wallet}>
        <p class="text-gray-600">Cargando proyectos...</p>
      </div>
    </section>
  </div>
</Layout>

<script>
  // Load projects for this builder
  document.addEventListener("DOMContentLoaded", () => {
    const list = document.getElementById("projects-list");
    if (!list) return;

    const wallet = list.getAttribute("data-wallet");
    if (!wallet) {
      list.innerHTML =
        '<p class="text-red-600">Error: No se encontr√≥ la direcci√≥n del wallet.</p>';
      return;
    }

    console.log("Loading projects for wallet:", wallet);

    fetch(`/api/builders/projects?wallet=${encodeURIComponent(wallet)}`)
      .then((res) => {
        console.log("Projects API response status:", res.status);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then((data) => {
        console.log("Projects API response data:", data);
        if (list) {
          if (data.projects && data.projects.length > 0) {
            const ul = document.createElement("ul");
            ul.className = "space-y-3";

            data.projects.forEach((p: any) => {
              const li = document.createElement("li");
              li.className = "border border-gray-200 rounded-lg p-4";

              // Title with badges
              const titleDiv = document.createElement("div");
              titleDiv.className = "flex items-center justify-between mb-2";

              const h3 = document.createElement("h3");
              h3.className = "font-semibold text-lg";
              h3.textContent = p.name;
              titleDiv.appendChild(h3);

              // Badges container
              const badgesDiv = document.createElement("div");
              badgesDiv.className = "flex gap-2 items-center";

              // Owner/Member badge
              const isOwner = p.owner_wallet === wallet;
              if (isOwner) {
                const ownerBadge = document.createElement("span");
                ownerBadge.className =
                  "px-2 py-1 text-xs font-medium rounded-full bg-[#9945FF]/10 text-[#9945FF]";
                ownerBadge.textContent = "üëë Propietario";
                badgesDiv.appendChild(ownerBadge);

                // Project verification status badge for owners (only show if not verified)
                if (p.status !== "verified" && p.status !== "active") {
                  const statusBadge = document.createElement("span");
                  statusBadge.className =
                    "px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800";
                  statusBadge.textContent = "Pendiente de Verificaci√≥n";
                  badgesDiv.appendChild(statusBadge);
                } else if (p.status === "verified") {
                  const statusBadge = document.createElement("span");
                  statusBadge.className =
                    "px-2 py-1 text-xs rounded-full bg-green-100 text-green-800";
                  statusBadge.textContent = "‚úì Verificado";
                  badgesDiv.appendChild(statusBadge);
                } else if (p.status === "active") {
                  const statusBadge = document.createElement("span");
                  statusBadge.className =
                    "px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800";
                  statusBadge.textContent = "Activo";
                  badgesDiv.appendChild(statusBadge);
                }
              } else {
                const memberBadge = document.createElement("span");
                memberBadge.className =
                  "px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800";
                memberBadge.textContent = "‚úì Miembro";
                badgesDiv.appendChild(memberBadge);

                // Project status badge for members
                const statusBadge = document.createElement("span");
                statusBadge.className = "px-2 py-1 text-xs rounded-full";
                if (p.status === "verified") {
                  statusBadge.className += " bg-green-100 text-green-800";
                  statusBadge.textContent = "‚úì Verificado";
                } else if (p.status === "active") {
                  statusBadge.className += " bg-blue-100 text-blue-800";
                  statusBadge.textContent = "Activo";
                } else {
                  statusBadge.className += " bg-yellow-100 text-yellow-800";
                  statusBadge.textContent = "Pendiente";
                }
                badgesDiv.appendChild(statusBadge);
              }

              titleDiv.appendChild(badgesDiv);
              li.appendChild(titleDiv);

              if (p.description) {
                const desc = document.createElement("p");
                desc.className = "text-gray-600 mt-1 mb-2";
                desc.textContent = p.description;
                li.appendChild(desc);
              }

              const linksDiv = document.createElement("div");
              linksDiv.className = "mt-2 flex gap-4 text-sm items-center";

              if (p.website) {
                const websiteLink = document.createElement("a");
                websiteLink.href = p.website;
                websiteLink.target = "_blank";
                websiteLink.className = "text-[#9945FF] hover:underline";
                websiteLink.textContent = "üåê Sitio web";
                linksDiv.appendChild(websiteLink);
              }

              if (p.twitter) {
                const twitterLink = document.createElement("a");
                twitterLink.href = `https://twitter.com/${p.twitter.replace("@", "")}`;
                twitterLink.target = "_blank";
                twitterLink.className = "text-[#9945FF] hover:underline";
                twitterLink.textContent = "üê¶ Twitter";
                linksDiv.appendChild(twitterLink);
              }

              if (p.discord) {
                const discordLink = document.createElement("a");
                discordLink.href = p.discord;
                discordLink.target = "_blank";
                discordLink.className = "text-[#9945FF] hover:underline";
                discordLink.textContent = "üí¨ Discord";
                linksDiv.appendChild(discordLink);
              }

              // Edit button for owners
              if (isOwner) {
                const editBtn = document.createElement("a");
                editBtn.href = `/builders/projects/edit?id=${p.id}`;
                editBtn.className =
                  "ml-auto px-3 py-1 text-sm bg-[#9945FF] text-white rounded-lg hover:bg-[#8338EB] transition-colors";
                editBtn.textContent = "‚úèÔ∏è Editar";
                linksDiv.appendChild(editBtn);
              }

              li.appendChild(linksDiv);
              ul.appendChild(li);
            });

            list.innerHTML = "";
            list.appendChild(ul);
          } else {
            list.innerHTML =
              '<p class="text-gray-600">No tienes proyectos asociados a√∫n.</p>';
          }
        }
      })
      .catch((err) => {
        console.error("Error loading projects:", err);
        if (list) {
          list.innerHTML = `<p class="text-red-600">Error al cargar proyectos: ${err.message}</p>`;
        }
      });
  });

  // Also handle client-side navigation
  document.addEventListener("astro:page-load", () => {
    const list = document.getElementById("projects-list");
    if (!list) return;

    const wallet = list.getAttribute("data-wallet");
    if (!wallet) return;

    console.log("Loading projects for wallet (navigation):", wallet);

    fetch(`/api/builders/projects?wallet=${encodeURIComponent(wallet)}`)
      .then((res) => {
        console.log("Projects API response status:", res.status);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then((data) => {
        console.log("Projects API response data:", data);
        if (list) {
          if (data.projects && data.projects.length > 0) {
            const ul = document.createElement("ul");
            ul.className = "space-y-3";

            data.projects.forEach((p: any) => {
              const li = document.createElement("li");
              li.className = "border border-gray-200 rounded-lg p-4";

              // Title with badges
              const titleDiv = document.createElement("div");
              titleDiv.className = "flex items-center justify-between mb-2";

              const h3 = document.createElement("h3");
              h3.className = "font-semibold text-lg";
              h3.textContent = p.name;
              titleDiv.appendChild(h3);

              // Badges container
              const badgesDiv = document.createElement("div");
              badgesDiv.className = "flex gap-2 items-center";

              // Owner/Member badge
              const isOwner = p.owner_wallet === wallet;
              if (isOwner) {
                const ownerBadge = document.createElement("span");
                ownerBadge.className =
                  "px-2 py-1 text-xs font-medium rounded-full bg-[#9945FF]/10 text-[#9945FF]";
                ownerBadge.textContent = "üëë Propietario";
                badgesDiv.appendChild(ownerBadge);

                // Project verification status badge for owners (only show if not verified)
                if (p.status !== "verified" && p.status !== "active") {
                  const statusBadge = document.createElement("span");
                  statusBadge.className =
                    "px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800";
                  statusBadge.textContent = "Pendiente de Verificaci√≥n";
                  badgesDiv.appendChild(statusBadge);
                } else if (p.status === "verified") {
                  const statusBadge = document.createElement("span");
                  statusBadge.className =
                    "px-2 py-1 text-xs rounded-full bg-green-100 text-green-800";
                  statusBadge.textContent = "‚úì Verificado";
                  badgesDiv.appendChild(statusBadge);
                } else if (p.status === "active") {
                  const statusBadge = document.createElement("span");
                  statusBadge.className =
                    "px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800";
                  statusBadge.textContent = "Activo";
                  badgesDiv.appendChild(statusBadge);
                }
              } else {
                const memberBadge = document.createElement("span");
                memberBadge.className =
                  "px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800";
                memberBadge.textContent = "‚úì Miembro";
                badgesDiv.appendChild(memberBadge);

                // Project status badge for members
                const statusBadge = document.createElement("span");
                statusBadge.className = "px-2 py-1 text-xs rounded-full";
                if (p.status === "verified") {
                  statusBadge.className += " bg-green-100 text-green-800";
                  statusBadge.textContent = "‚úì Verificado";
                } else if (p.status === "active") {
                  statusBadge.className += " bg-blue-100 text-blue-800";
                  statusBadge.textContent = "Activo";
                } else {
                  statusBadge.className += " bg-yellow-100 text-yellow-800";
                  statusBadge.textContent = "Pendiente";
                }
                badgesDiv.appendChild(statusBadge);
              }

              titleDiv.appendChild(badgesDiv);
              li.appendChild(titleDiv);

              if (p.description) {
                const desc = document.createElement("p");
                desc.className = "text-gray-600 mt-1 mb-2";
                desc.textContent = p.description;
                li.appendChild(desc);
              }

              const linksDiv = document.createElement("div");
              linksDiv.className = "mt-2 flex gap-4 text-sm items-center";

              if (p.website) {
                const websiteLink = document.createElement("a");
                websiteLink.href = p.website;
                websiteLink.target = "_blank";
                websiteLink.className = "text-[#9945FF] hover:underline";
                websiteLink.textContent = "üåê Sitio web";
                linksDiv.appendChild(websiteLink);
              }

              if (p.twitter) {
                const twitterLink = document.createElement("a");
                twitterLink.href = `https://twitter.com/${p.twitter.replace("@", "")}`;
                twitterLink.target = "_blank";
                twitterLink.className = "text-[#9945FF] hover:underline";
                twitterLink.textContent = "üê¶ Twitter";
                linksDiv.appendChild(twitterLink);
              }

              if (p.discord) {
                const discordLink = document.createElement("a");
                discordLink.href = p.discord;
                discordLink.target = "_blank";
                discordLink.className = "text-[#9945FF] hover:underline";
                discordLink.textContent = "üí¨ Discord";
                linksDiv.appendChild(discordLink);
              }

              // Edit button for owners
              if (isOwner) {
                const editBtn = document.createElement("a");
                editBtn.href = `/builders/projects/edit?id=${p.id}`;
                editBtn.className =
                  "ml-auto px-3 py-1 text-sm bg-[#9945FF] text-white rounded-lg hover:bg-[#8338EB] transition-colors";
                editBtn.textContent = "‚úèÔ∏è Editar";
                linksDiv.appendChild(editBtn);
              }

              li.appendChild(linksDiv);
              ul.appendChild(li);
            });

            list.innerHTML = "";
            list.appendChild(ul);
          } else {
            list.innerHTML =
              '<p class="text-gray-600">No tienes proyectos asociados a√∫n.</p>';
          }
        }
      })
      .catch((err) => {
        console.error("Error loading projects:", err);
        if (list) {
          list.innerHTML = `<p class="text-red-600">Error al cargar proyectos: ${err.message}</p>`;
        }
      });
  });
</script>
