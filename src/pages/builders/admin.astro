---
// src/pages/builders/admin.astro
import Layout from "../../layouts/Layout.astro";
import { getSession } from "../../lib/auth";

const session = await getSession(Astro.cookies);
const ADMIN_WALLET =
  import.meta.env.ADMIN_WALLET || "YOUR_ADMIN_WALLET_ADDRESS";

// Check if user is admin
if (!session?.wallet || session.wallet !== ADMIN_WALLET) {
  return Astro.redirect("/builders");
}
---

<Layout title="Admin Panel | Construyendo Juntos">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6 flex justify-between items-center">
      <h1 class="text-3xl font-bold">Admin Panel</h1>
      <a href="/builders" class="text-[#9945FF] hover:text-[#8338EB]"
        >‚Üê Volver</a
      >
    </div>

    <div class="mb-6 flex gap-4">
      <a
        href="/api/builders/export"
        class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
      >
        Exportar CSV de Builders
      </a>
      <a
        href="/api/projects/export"
        class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
      >
        Exportar CSV de Proyectos
      </a>
    </div>

    <section
      class="mb-12 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"
    >
      <div class="p-6 border-b border-gray-200 bg-gray-50">
        <h2 class="text-2xl font-semibold text-gray-900">
          Builders Registrados
        </h2>
      </div>
      <div id="builders-list" class="p-0">
        <p class="p-6 text-gray-600">Cargando builders...</p>
      </div>
    </section>

    <section
      class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"
    >
      <div class="p-6 border-b border-gray-200 bg-gray-50">
        <h2 class="text-2xl font-semibold text-gray-900">Proyectos</h2>
      </div>
      <div id="admin-projects-list" class="p-0">
        <p class="p-6 text-gray-600">Cargando proyectos...</p>
      </div>
    </section>
  </div>
</Layout>

<script>
  // Load builders list via API
  fetch("/api/builders/list")
    .then((res) => res.json())
    .then((data) => {
      const list = document.getElementById("builders-list");
      if (list && data.builders) {
        if (data.builders.length === 0) {
          list.innerHTML =
            '<p class="text-gray-600">No hay builders registrados a√∫n.</p>';
          return;
        }
        // Create table using DOM methods to avoid innerHTML issues
        const container = document.createElement("div");
        container.className = "overflow-x-auto";

        const table = document.createElement("table");
        table.className = "min-w-full divide-y divide-gray-200";

        // Create thead
        const thead = document.createElement("thead");
        thead.className = "bg-gray-50";
        const headerRow = document.createElement("tr");
        ["Wallet", "Nombre", "Email", "Estado", "Rol", "Fecha"].forEach(
          (text) => {
            const th = document.createElement("th");
            th.className =
              "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            th.textContent = text;
            headerRow.appendChild(th);
          },
        );
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create tbody
        const tbody = document.createElement("tbody");
        tbody.className = "bg-white divide-y divide-gray-200";

        data.builders.forEach((b: any) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";

          // Wallet
          const tdWallet = document.createElement("td");
          tdWallet.className = "px-6 py-4 whitespace-nowrap text-sm font-mono";
          tdWallet.textContent = `${b.wallet_address.slice(0, 8)}...${b.wallet_address.slice(-6)}`;
          tr.appendChild(tdWallet);

          // Name
          const tdName = document.createElement("td");
          tdName.className = "px-6 py-4 whitespace-nowrap text-sm";
          tdName.textContent = b.name || "-";
          tr.appendChild(tdName);

          // Email
          const tdEmail = document.createElement("td");
          tdEmail.className = "px-6 py-4 whitespace-nowrap text-sm";
          tdEmail.textContent = b.email || "-";
          tr.appendChild(tdEmail);

          // Status
          const tdStatus = document.createElement("td");
          tdStatus.className = "px-6 py-4 whitespace-nowrap";
          const statusSpan = document.createElement("span");
          statusSpan.className = "px-2 py-1 text-xs rounded-full";
          if (b.status === "active") {
            statusSpan.className += " bg-green-100 text-green-800";
          } else if (b.status === "verified") {
            statusSpan.className += " bg-blue-100 text-blue-800";
          } else {
            statusSpan.className += " bg-yellow-100 text-yellow-800";
          }
          statusSpan.textContent = b.status;
          tdStatus.appendChild(statusSpan);
          tr.appendChild(tdStatus);

          // Role
          const tdRole = document.createElement("td");
          tdRole.className = "px-6 py-4 whitespace-nowrap text-sm";
          tdRole.textContent = b.role || "builder";
          tr.appendChild(tdRole);

          // Date
          const tdDate = document.createElement("td");
          tdDate.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
          tdDate.textContent = new Date(b.created_at).toLocaleDateString();
          tr.appendChild(tdDate);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);

        list.innerHTML = "";
        list.appendChild(container);
      }
    })
    .catch((err) => {
      console.error("Error loading builders:", err);
      const list = document.getElementById("builders-list");
      if (list) {
        list.innerHTML =
          '<p class="text-red-600">Error al cargar builders.</p>';
      }
    });

  // Load projects list
  fetch("/api/projects/list")
    .then((res) => res.json())
    .then((data) => {
      const list = document.getElementById("admin-projects-list");
      if (list && data.projects) {
        if (data.projects.length === 0) {
          list.innerHTML =
            '<p class="p-6 text-gray-600">No hay proyectos registrados a√∫n.</p>';
          return;
        }

        const container = document.createElement("div");
        container.className = "overflow-x-auto";

        const table = document.createElement("table");
        table.className = "min-w-full divide-y divide-gray-200";

        const thead = document.createElement("thead");
        thead.className = "bg-gray-50";
        const headerRow = document.createElement("tr");
        ["ID", "Proyecto", "Propietario", "Estado"].forEach((text) => {
          const th = document.createElement("th");
          th.className =
            "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
          th.textContent = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        tbody.className = "bg-white divide-y divide-gray-200";

        data.projects.forEach((p: any) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";

          // ID (with copy button)
          const tdId = document.createElement("td");
          tdId.className =
            "px-6 py-4 whitespace-nowrap text-xs font-mono text-gray-500";
          tdId.innerHTML = `
            <div class="flex items-center gap-2">
              <span>${p.id.slice(0, 8)}...</span>
              <button class="text-[#9945FF] hover:text-[#8338EB]" onclick="navigator.clipboard.writeText('${p.id}'); alert('ID copiado');" title="Copiar ID completo">
                üìã
              </button>
            </div>
          `;
          tr.appendChild(tdId);

          // Name
          const tdName = document.createElement("td");
          tdName.className =
            "px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900";
          tdName.textContent = p.name;
          tr.appendChild(tdName);

          // Owner
          const tdOwner = document.createElement("td");
          tdOwner.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono";
          tdOwner.textContent = `${p.owner_wallet.slice(0, 6)}...${p.owner_wallet.slice(-4)}`;
          tr.appendChild(tdOwner);

          // Status
          const tdStatus = document.createElement("td");
          tdStatus.className = "px-6 py-4 whitespace-nowrap text-sm";
          const statusSpan = document.createElement("span");
          statusSpan.className =
            "px-2 py-1 text-xs rounded-full font-bold uppercase";
          if (p.status === "active" || p.status === "verified") {
            statusSpan.className += " bg-green-100 text-green-800";
          } else {
            statusSpan.className += " bg-yellow-100 text-yellow-800";
          }
          statusSpan.textContent = p.status;
          tdStatus.appendChild(statusSpan);
          tr.appendChild(tdStatus);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
        list.innerHTML = "";
        list.appendChild(container);
      }
    })
    .catch((err) => {
      console.error("Error loading projects:", err);
    });
</script>
